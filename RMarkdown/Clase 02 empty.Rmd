---
title: "Análisis Multivariados: C2 - Métodos canónicos (dependientes)"
author: "Blgo. Irwing S. Saldaña"
output: html
editor_options: 
  chunk_output_type: console
---

Instala las siguientes librerías

```{r}
# Instalación de la librería ggords ------------------------------ -
# REPO: https://github.com/wdy91617/ggords
# VIÑETA: https://fawda123.github.io/ggord/articles/Overview.html
remotes::install_github("wdy91617/ggords")

# Instalación de la librería ggord ------------------------------ -
# REPO: https://github.com/fawda123/ggord
# VIÑETA: https://github.com/wdy91617/ggords
options(repos = c(
    fawda123 = 'https://fawda123.r-universe.dev',
    CRAN = 'https://cloud.r-project.org'))
install.packages('ggord')

# Instalación de la librería ggvegan
# REPO: https://github.com/gavinsimpson/ggvegan
remotes::install_github("gavinsimpson/ggvegan", force=TRUE)
```

Activa las siguientes librerías

```{r}
# Cargar librerías de trabajo
library(tidyverse)
library(ade4)
library(factoextra)
library(FactoMineR)
library(vegan)
library(ape)
library(ca)
library(ggord)
library(ggords)
library(ggvegan)
```

Carga la siguiente base de datos inicial

```{r}
# DATOS 1
# Cargar base de datos aravo
data("aravo")
help(aravo)

# Extrar las matrices de trabajo
bio <- aravo$spe %>% as_tibble()
amb <- aravo$env %>% as_tibble() %>% select(-ZoogD, -PhysD, -Form)

# DATOS 2
# Cargar base de datos "cca_spe.csv" y "cca_env.csv"
especies <- read.csv("slide2/bases/cca_spe.csv", row.names=1, sep=";")
especies <- read.csv(file.choose(), row.names=1, sep=";")

ambiente <- read.csv("slide2/bases/cca_env.csv", row.names=1, sep=";")
ambiente <- read.csv(file.choose(), row.names=1, sep=";")

# DATOS 3
loboGen <- openxlsx::read.xlsx("slide2/bases/wolf_gen.xlsx") 
loboGen <- openxlsx::read.xlsx(file.choose()) 

loboAmb <- openxlsx::read.xlsx("slide2/bases/wolf_env.xlsx") 
loboAmb <- openxlsx::read.xlsx(file.choose()) 

```

Recuerda que, como todo método restringido o canónico, para realizar CCA o RDA debes tener dos conjuntos de datos: **una matriz Y** (de variables respuesta) y una **matriz X** (de variables explicativas con las que quieres "explicar" la variabilidad del conjunto de datos y). Ambos métodos te ayudarán a visualizar la relación entre las observaciones (filas), especies (columnas de la matriz Y), y variables ambientales (columnas de la matriz X).

# **1. Análisis de Correspondencia Canónica (CCA)**

## **1.1. Realicemos un CA para ver los resultados**

```{r}
# Transformar la base de datos a logaritmo para evitar 
# exceso de peso a las especies raras generado por 
# las distancias de Chi-Cuadrado
str(especies)
range(especies)
especies_log <- log1p(especies)

# Realizar el CA
CA <- ca(especies_log)
summary(CA)

# Gráfico rápido del CA
fviz_ca_biplot(CA, arrows=c(FALSE, TRUE))
```

## **1.2. Ejecución del CCA**

```{r}
# Modelo CCA
# BASE DE DATOS Y : BIODIVERSIDAD :  especies_log
# BASE DE DATOS X : AMBIENTAL     :  ambiente

str(especies_log)
str(ambiente)

CCA <- cca(especies_log ~ ., data=ambiente)
summary(CCA)
RsquareAdj(CCA)

# CCA Parsimonioso
CCA_nulo <- update(CCA, . ~ 1)

ordiR2step(CCA_nulo, scope=formula(CCA), R2scope=TRUE, trace=0)

# Guardando el mejor modelo
mejor_CCA <- cca(formula = especies_log ~ WaterContent +
FallenTwigs + BareSand + CoverMoss, data = ambiente)

```

## **1.3. Significancia del CCA con Test de Permutaciones**

```{r}
# Test de Permutaciones para significancia del modelo
perm <- permustats(anova(mejor_CCA))
summary(perm)
densityplot(perm)

anova.cca(mejor_CCA)

# Test de Permutaciones para significancia de los ejes canónicos
perm_axis <- permustats(anova(mejor_CCA, by="axis"))
summary(perm_axis)
densityplot(perm_axis)

anova.cca(mejor_CCA, by="axis")

# Test de Permutaciones para significancia de las variables explicativas
# de manera secuencial
anova.cca(mejor_CCA, by="terms")

# Test de Permutaciones para significancia de las variables explicativas
# de manera individual
anova.cca(mejor_CCA, by="margin")

```

## **1.4. Gráfico del CCA**

```{r}
mejor_CCA$call
variables <- c("WC", "FT", "BS", "CM")

library(ggords)

ggcca(mejor_CCA,  # Cambiar el modelo
      obslab = TRUE, 
      obssize=3, 
      spesize=4,
      fsize=4, 
      mflabs=variables, # Solo cuando requieran cambiar etiquetas
      scaling=2,
      obsFonts = "sans",
      speFonts = "sans",
      fFonts = "sans")+
  theme_minimal()+
  xlim(-3,1.5)+
  ylim(-2,3)
```


# **2. Análisis de Redundancia (RDA)**

## **2.1 Procedimiento para un RDA o tb-RDA**

```{r}
# Preprocesamiento
loboAmb2 <- loboAmb[,5:12]
colnames(loboAmb2) <- c("AMT","MDR","sdT","AP","cvP","NDVI","Elev","Tree")

loboGen2 <- loboGen[,-1] 

# Crea el RDA
RDA <- ...

# Ver resultados del RDA


# R2 y R2 ajustado del RDA 


# Ejes canónicos y No Canónicos



# Significancias con Test de Permutaciones


# Verificar Colinearidad de las variables ambientales (X)


# Gráfico de RDA con el método de graficación básico
loboAmb$ecotype <- factor(loboAmb$ecotype)
levels(loboAmb$ecotype) <- c("Western Forest","Boreal Forest","Arctic","High Arctic","British Columbia","Atlantic Forest")

# Definir el número de niveles y columna para coloreo
colores <- scales::hue_pal()(6)[loboAmb$ecotype] 

plot(RDA, type="n", scaling=3) # OBJETO RDA
points(RDA, display="species", pch=20, cex=0.7,  # OBJETO RDA
       col="gray32", scaling=3)  # Definir escala
points(RDA, display="sites", pch=21, cex=1.3, # OBJETO RDA
       col="gray32", scaling=3, bg=colores) # Definir escala
text(RDA, # OBJETO RDA
     scaling=3, # Definir escala
     display="bp", col="#0868ac", cex=1)
legend("bottomright", legend=levels(loboAmb$ecotype), # Columna coloreo 
       bty="n", col="gray32", pch=21, cex=1,
       pt.bg=scales::hue_pal()(6)) # Definir el número de niveles
```

## **2.2 Procedimiento para un tb-RDA**

```{r}
# Pre procesamiento para distancias de bray Curtis
hell_esp <- ...

# Crea el objeto dbRDA
tbRDA <- ...

# Ver resultados del dbRDA


# R2 y R2 ajustado del dbRDA 


# Ejes canónicos y No Canónicos


# dbRDA Parsimonioso
tbRDA_nulo <- ...

ordiR2step(...)

# Guardando el mejor modelo
mejor_tbRDA <- ...


# Significancias con Test de Permutaciones


# Verificar Colinearidad de las variables ambientales (X)


# Triplot Exploratorio


# Triplot final
autoplot(mejor_tbRDA,
         geom = c('point','text'),
         display = c("wa", 'sp', 'bp'),
         arrows = F,
         scaling = 2, 
         axes=c(1,2))+
  # labs(x='dbRDA1 48.35%', y="dbRDA2 19.96%",
  #     title="Porcentaje de Varianza Canónica = 72.65%")+
  xlim(-1.5,1.2)+
  scale_color_manual(values=c("red","blue"))+
  theme_bw()+
  theme(legend.position = "none")

```


## **2.2 Procedimiento para un db-RDA**

```{r}
# Pre procesamiento para distancias de bray Curtis
log_esp <- ...

# Crea el objeto dbRDA
dbRDA<- ...

# Ver resultados del dbRDA


# R2 y R2 ajustado del dbRDA 

# Ejes canónicos y No Canónicos



# dbRDA Parsimonioso
dbRDA_nulo <- ...

# Guardando el mejor modelo
mejor_dbRDA <- ...

# Significancias con Test de Permutaciones


# Verificar Colinearidad de las variables ambientales (X)


# Triplot Exploratorio


# Triplot final
library(ggvegan)
autoplot(mejor_dbRDA,
         geom = c('point','text'),
         display = c("wa", 'sp', 'bp'),
         arrows = F,
         scaling = 2, 
         axes=c(1,2))+
  #labs(x='dbRDA1 69.69%', y="dbRDA2 25.08%",
  #     title="Porcentaje de Varianza Canónica = 78.25%")+
  xlim(-1.5,1.2)+
  scale_color_manual(values=c("red"))+
  theme_bw()+
  theme(legend.position = "none")
```

## **3.1. Ejercicio RDA completo**

Trabajaremos con los datos `mite` y `mite.env` de la librería `vegan`que hemos modificado previamente.

Ambas bases pertenecen al mismo estudio, en el que se busca encontrar las variables ambientales (variables explicativas almacenadas en `mite.env`) que expliquen la variabilidad en las especies de ácaros (diversidad de abundancia de especies en `mite`).

Las variables ambientales (`mite.env`) son:

-   **SubsDens:** Densidad del sustrado (g/L)

-   **WatrCont:** Contenido de agua del sustrato (g/L)

-   **Substrate (sub):** tipo de sustrato (Sphagn1, Sphagn2, Sphagn3, Sphagn, Litter, Barepeat, e Interface)

-   **Shrub (arb):** densidad del matorral (none, few, many)

-   **Topo (top):** microtopografía (Blanket, Hummock)

Con ello se pueden hacer inferencias de qué especies puedan estar más asociados a un tipo de sustrato, a un tipo de microtopografía, a presencia de mucho o poco matorral, al contenido de agua del sustrat, etc. La manera de ver esas asociaciones es con el **triplot del RDA**.

Realiza un RDA para encontrar la asociación que tienen las variables ambientales con la diversidad de ácaros. Verifica si el modelo es significativo, si los ejes canónicos son significativo y la cantidad de varianza explicada por el modelo. Además, encuentra explicaciones sobre qué especies se encuentran relacionadas con las variables ambientales.

```{r}
data("mite")
data("mite.env")
```


```{r}
# Realiza la transformación de Hellinger a la base de datos
# mite para que esta cumpla con los requerimientos del RDA (tb-RDA)
mite.hell <- ...

# Realiza el RDA enfrentando la base de datos transformada
# como matriz y, y todas las variables de mite.env como matriz x
# define escalado scale=F, y el scaling=1
tbRDA2 <- ...

tbRDA2_nulo <- ...

# Encuentra el tb-RDA Parsimonioso



# tb-RDA final
tbRDA.final <- ...


# Verifica si el RDA y los ejes son significativos



# Gráfico con Autoplot de ggvegan



```
