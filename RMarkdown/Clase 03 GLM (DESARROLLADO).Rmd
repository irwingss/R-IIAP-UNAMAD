---
title: "Modelamiento Avanzado: GLM y GLMM"
Subtitle: "Ciencia de Datos en R aplicada a la Conservación de Fauna Silvestre"
Author: "Blgo. Irwing S. Saldaña"
output: html_document
editor_options:
  chunk_output_type: console
---

Librerías a usar

```{r warning=FALSE, message=FALSE}
library(ggpubr)
library(broom)
library(broom.mixed)
library(ggfortify)
library(tidyverse)
library(lme4)
library(MuMIn)
library(performance)
```

# **1. Regresión Logística (Bernoulli)**

Se desea evaluar el efecto de un tratamiento en el peso de 50 pollitos. Se tomaron dos medidas de cada pollito, una antes del tratamiento (pre) y otra después (post).

## **1.1. Base de datos**
```{r}
# Cargando el excel pez.xlsx
pez <- openxlsx::read.xlsx("slide3/bases/pez.xlsx")
pez <- openxlsx::read.xlsx(file.choose())

pez$poblacion <- factor(pez$poblacion)
pez$sexo <-  factor(pez$sexo)
pez$tactica <- factor(pez$tactica,  labels = c("fem"="Hembra",
                                       "sneak"="Furtivo",
                                       "terr"="Territorial"))

str(pez)
names(pez)
```

## **1.2. Creando el modelo inicial (FULL)**
```{r}
# Modelo Full
modpez <- glm(punto_rojo ~ longitud + tactica + sexo + peso, 
              data=pez, family=binomial(link="logit"))

modpez <- glm(punto_rojo ~ longitud + tactica + sexo + peso, 
              data=pez, family="binomial")

summary(modpez)
```

## **1.3. Stepwise Regression para la selección de modelos**
```{r}
# Selección Stepwise 
MASS::stepAIC(modpez)
# drop1()
# add1()

modpez2 <- glm(formula = punto_rojo ~ longitud + tactica, family = "binomial", data = pez)

# Crear modelo con interacciones
modpez3 <- glm(formula = punto_rojo ~ longitud * tactica, family = "binomial", data = pez)

# Commparar modelos (Likelihood Ratio Test)
AIC(modpez, modpez2, modpez3) %>% arrange(AIC)

anova(modpez, modpez2, test="LRT")
anova(modpez3, modpez2, test="LRT")

```

## **1.4. Calidad del modelo**
```{r}
# Cálculo del Pseudo R2
performance::r2(modpez3)

# Verificar la colinearidad de las variavles 
# (no necesario si hay interacción)
check_collinearity(modpez2)
check_collinearity(modpez3)

# Significancia del modelo
modpez3_nulo <- update(modpez3, . ~ 1)
anova(modpez3, modpez3_nulo, test="LRT")
```

## **1.5. Obteniendo e interpretando los resultados**
```{r}
# Interpretación de coeficientes del modelo Logístico (Bernoulli)
library(sjPlot)

tab_model(modpez2)

tab_model(modpez3)

predict(modpez3, data.frame(longitud=90, tactica ="Furtivo"),
        type="response")

predict(modpez3, data.frame(longitud=90, tactica ="Territorial"),
        type="response")

predict(modpez3, data.frame(longitud=90, tactica ="Hembra"),
        type="response")

range(pez$longitud)

tidy(modpez3, conf.int=TRUE, exponentiate=FALSE)

y = b0 + b1*x1 + b2*x2 + b3*x1*x2
y = -5.01  + 0.0426*90 + -2.90*1 + 0.0819*90*1

# Función logit
# exp(FORMULA) / (1 + exp(FORMULA))
exp(y) / (1 + exp(y))

```

## **1.6. Gráfico Final**
```{r}
# Gráfico semi-automático con sjPlot
library(sjPlot)

plot_model(modpez3)
plot_model(modpez3, type="est", show.values=TRUE,
           show.intercept=TRUE)

plot_model(modpez3, type="pred", terms = c("longitud"), 
           show.data = TRUE)+
  aes(color="A", fill="A")+
  scale_color_manual(values="blue")+ # DEFINIR colOR LINEA
  scale_fill_manual(values="blue")+ # DEFINIR coLO SOMBRA
  theme_bw()

plot_model(modpez3, type="pred", terms = c("tactica")) + 
  theme_bw()

# Set2, Set1, Dark2

plot_model(modpez3, type="int", show.data = TRUE, colors = "Dark2")+
  theme_bw() +
  labs(x="Longitud (cm)", 
       y="Probabilidad de Opérculo con punto rojo", 
       title="", 
       color = "Táctica de \nApareamiento")

plot_model(modpez3, type="int", show.data = TRUE, 
           colors = c("cyan4","darkorange","purple"),
           jitter=c(0,0.05))+
  theme_bw()
```

# **2. Regresión Logística (Binomial)**

## **2.1. Base de datos**
```{r}
# Cargando el excel zorrito.xlsx
zorrito <- openxlsx::read.xlsx("slide3/bases/zorrito.xlsx")
zorrito <- openxlsx::read.xlsx(file.choose())
str(zorrito)

```

## **2.2. Creando los modelos: sin y con interacción**
```{r}
# Creando los modelos
model1 <- glm(cri_int ~ genAD922 + gen208S2, data=zorrito, 
              family="binomial", weights=intentos)

model2 <- glm(cri_int ~ genAD922 * gen208S2, data=zorrito, 
              family="binomial", weights=intentos)

# Commparar modelos
anova(model1, model2, test="LRT")

```

## **2.3. Calidad del modelo**
```{r}
# Cálculo del Pseudo R2 para modelos logisticos Binomiales
 R2logit<- function(modelo){
    R2 <- 1-(modelo$deviance/modelo$null.deviance)
    return(R2)
 }


R2logit(model1) #Pseudo R2 de McFadden

# Verificar la colinearidad de las variables
check_collinearity(model1)

# Significancia del modelo
model1_nulo <- update(model1, . ~ 1)
anova(model1, model1_nulo, test="LRT")

```

## **2.4. Obteniendo e interpretando los resultados**
```{r}
# Generemos el resumen y veamos los coeficientes
summary(model1)
check_overdispersion(model1)

# Si es que encuentran que hay sobredispersión
# deben hacer el modelo con Fam. Quasibinomial
MODELO_NO_REQUERIDO <- glm(cri_int ~ genAD922 + gen208S2, data=zorrito, 
              family="quasibinomial", weights=intentos)

summary(MODELO_NO_REQUERIDO)
```

## **2.5. Interpretación con el Gráfico Final**
```{r}
# Gráfico semi-automático con sjPlot
library(sjPlot)

plot_model(model1, show.values = TRUE, show.p = TRUE, vline.color = "gray70") + 
  theme_bw()

plot_model(model1, type="pred", show.data = TRUE, terms = c("genAD922")) + 
  theme_bw()

plot_model(model1, type="pred", show.data = TRUE, terms = c("gen208S2")) + 
  theme_bw()

plot_model(model1, type="pred", show.data = TRUE, 
           terms = c("gen208S2"), dot.alpha=0.4, colors="purple") + 
  theme_bw()+
  aes(color="", fill="")+
  theme(legend.position="none")+
  labs(y="Probabilidad", x="Gen 208S2",
       title= "Expresión del gen 208S2",
         subtitle=expression(paste("en poblaciones de Ecuador y Perú de Zorro de Sechura ", italic("Lycalopex sechurae"))))


predict(model1, data.frame(genAD922= 1 , gen208S2=0.5),
        type="response")

y = -0.9802 + -1.6558*1 + 4.5605*0.5

exp(y) / (1+exp(y))

```

# **3. Regresión de Poisson**

## **3.1. Cargando la base de datos**

```{r}
# Cargando el excel aves.xlsx
aves <- openxlsx::read.xlsx("slide3/bases/aves.xlsx")
aves <- openxlsx::read.xlsx(file.choose())
str(aves)
```
  
## **3.2. Generando la regresión de Poisson inicial**
```{r}
# Generando el modelo inicial (FULL)
glm.aves <- glm(r_total ~temp_pa+nieve+bosque+elev,
                data=aves, family="poisson")
summary(glm.aves)
```

## **3.3. Selección del mejor modelo**
```{r}
# Stepwise regressión: usando el AIC para la selección
MASS::stepAIC(glm.aves)

glm.aves2 <- glm(formula = r_total ~ temp_pa + nieve, 
                 family = "poisson", data = aves)

glm.aves3 <- glm(formula = r_total ~ temp_pa * nieve, 
                 family = "poisson", data = aves)

# Comparación de modelos
AIC(glm.aves, glm.aves2, glm.aves3) %>% arrange(AIC)

# Vista previa de los resultados
anova(glm.aves3, glm.aves2, test="LRT")

```

## **3.4. Validando el mejor modelo Poisson**
```{r}
# Pseudo R2 de CoxSnell
performance::r2_coxsnell(glm.aves3)
performance::r2(glm.aves3)

# Chequeo de la colinearidad de las variables
check_collinearity(glm.aves3)
check_collinearity(glm.aves2)

# Chequeo de presencia de outliers
check_outliers(glm.aves3)

# Chequeo de cero inflados
check_zeroinflation(glm.aves3)

# Chequeo de Sobredispersión
check_overdispersion(glm.aves3)
```

## **3.5. Interpretación del modelo**
```{r}
# Veamos el resumen
summary(glm.aves3)

# Obtener los cocientes de tasas de incidencia (Incidence Rate Ratios, IRR)
# Es decir, simplemente, los coeficientes del modelo de Poisson
coef(glm.aves3)

# Interpretando en porcentajes de incremento o disminución de el promedio esperado
exp(coef(glm.aves3))

# y = B0 + B1*x1 + B2*X2
y = 1.2584592358 + 0.0300293590*0 + -0.0118760386*0
exp(y)

y = 1.2584592358 + 0.0300293590*10 + -0.0118760386*100
exp(y)

y = 1.2584592358 + 0.0300293590*20 + -0.0118760386*10
exp(y)

# y = B0 + B1*x1 + B2*X2 + B3*x1*x2
y = 1.2584592358 + 0.0300293590*20 + -0.0118760386*10 + 0.0007775615*20*10
exp(y)

tidy(glm.aves3, exponentiate=TRUE, conf.int=TRUE)
1.03 - 1 # para todo valor mayor 1 (ESTIMADO - 1)
(1.03 - 1)*100
# Por cada unidad de aumento de Temp_pa, se espera que la riqueza
# aumente en 3%

# Por cada unidad de aumento de Temp_pa, se espera que la riqueza
# aumente por un factor multiplicativo de 1.03.

1 - 0.988 # oara todo valor menor de 1 (1 - ESTIMADO)
(1 - 0.988)*100

# Por cada unidad de aumento en nieve, se espera que la riqueza
# disminuya en 1.2% (por un factor multiplicativo de 0.998)

# Interpretando algunas situaciones en concreto
predict(glm.aves3, data.frame(temp_pa = 20, nieve=10), type="response")

```

## **3.6 Gráficos finales del modelo**
```{r}
# IRR Plot
plot_model(glm.aves3)

plot_model(glm.aves3, show.values = TRUE, show.p = TRUE, 
           vline.color = "gray70", digits = 4) + 
  theme_bw()+
  labs(title="", y="Cocientes de Tasas de Incidencia (IRR)")+
  scale_x_discrete(labels = c("temp_pa"="Temperatura \nPromedio \nAnual",
                              "nieve"="Nieve", 
                              "temp_pa:nieve"="Interacción \nTemp:Nieve"))+
  scale_y_continuous(limits = c(0.95,1.07), breaks = round(seq(0.95,1.08, length=7),2))


# Gráfico de efectos de Nieve sobre la riqueza total
plot_model(glm.aves3, type="eff", show.data = T, terms = c("nieve"), show.legend = F,
           colors = "#5f00db")+aes(color="", fill="")+ 
  theme_bw()

# Gráfico de efectos de Temperatura Promedio Anual sobre la riqueza total
plot_model(glm.aves3, type="pred", show.data = T, terms = c("temp_pa"), show.legend = F,
           colors = "#5f00db")+aes(color="", fill="")+ 
  theme_bw()

# Gráfico de interacciones
plot_model(glm.aves3, type="eff", terms= c("temp_pa","nieve[10,20,40,60]"))
plot_model(glm.aves3, type="eff", terms= c("temp_pa","nieve[10,20,30]"))

```

# **4. Regresión Binomial Negativa**

```{r}
# Generar el mejor modelo Poisson utilizando la familia Binomial Negativa
# Si el modelo no necesita lidiar con sobredispersión aparecerá una advertencia
check_overdispersion(glm.aves3)

library(MASS)
glm.aves4 <- glm.nb(formula = r_total ~ temp_pa * nieve, data = aves, 
                    control=glm.control(maxit = 100))

summary(glm.aves4)
```
