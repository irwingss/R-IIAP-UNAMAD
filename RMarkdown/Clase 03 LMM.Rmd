---
title: "Análisis Estadístico Lineal Avanzado con R"
author: "Blgo. Irwing S. Saldaña"
output: html
editor_options: 
  chunk_output_type: console
---

# Instalar librería
```{r}
install.packages("MuMIn")
install.packages("sjPlot")
install.packages("ggeffects")
install.packages("glmmTMB")
install.packages("lme4")
install.packages("AICcmodavg")
install.packages("broom")
install.packages("stargazer")
install.packages("broom.mixed")
remotes::install_github("easystats/easystats")
devtools::install_github("strengejacke/ggeffects")
```

# Activar librerías
```{r}
library(ggpubr)
library(broom)
library(broom.mixed)
library(ggfortify)
library(tidyverse)
library(lme4)
library(MuMIn)
```

# **1. Modelos Lineales de Efectos Mixtos**

```{r}
# Cargar la base de datos ranas.xlsx
ranas <- openxlsx::read.xlsx("slide3/bases/ranas.xlsx")
ranas <- openxlsx::read.xlsx(file.choose())

# Inspecionemos al objeto ranas
str(ranas)
names(ranas)
View(ranas)
```

## **1.1. Siempre se comienza con un modelo lineal**

Siempre es necesario hacer gráficos exploratorios para tener una idea de la relación entre la variable respuesta y las variables explicativas, incluyendo alguna variable de efecto aleatorio que se piense pueda tener una influencia en nuestros resultados.

```{r}
# Gráficos de inspección de la relación entre long_mm y peso, incluyendo al origen
ggscatter(x="long_mm",y="peso_mg", color="origen", 
          data=ranas, add="reg.line")+
  facet_wrap(~origen)

# Modelo Lineal exploratorio
mod1 <- lm(peso_mg ~ long_mm, data=ranas)

# Resultados
summary(mod1)
sjPlot::tab_model(mod1)

# Boxplots de residuales vs variable de agrupamiento
ranas.au <- augment(mod1)
ranas.au$origen <- ranas$origen

ggboxplot(x="origen", y=".resid", data=ranas.au)+
  geom_hline(yintercept=0, color="red", lty=2)

# Revisando las asunciones del modelo lineal
autoplot(mod1)
resid(mod1) |> nortest::ad.test()
```

Se puede aplicar otro enfoque, ¿Qué sucede si incluyo la variable origen en el modelo?. Realicemos este segundo modelo y revisemos todo

```{r}
# Realizamos el modelo
mod2 <- lm(peso_mg ~ long_mm + origen, data=ranas)

# Resultados
summary(mod2)
sjPlot::tab_model(mod2)

# Comparemos si este modelo es mejor que el anterior
anova(mod1, mod2)

# Boxplots de residuales vs variable de agrupamiento
ranas.au2 <- augment(mod2)

ggboxplot(x="origen", y=".resid", data=ranas.au2)+
  geom_hline(yintercept=0, color="red", lty=2)
car::leveneTest(ranas$peso_mg, ranas$origen, center = mean)

# Revisando las asunciones del modelo lineal
autoplot(mod2)
resid(mod2) |> nortest::ad.test()
```

## **1.2. Ejecución del Modelo Lineal de Efectos Mixtos**

```{r}
# Creación de los modelos de efectos mixtos
library(lme4)
mod3 <- lmer(peso_mg ~ long_mm + (1|origen), data=ranas, REML=FALSE)
mod4 <- lmer(peso_mg ~ long_mm + (long_mm|origen), data=ranas, REML=FALSE)

mod_nulo2 <- update(mod2, . ~ 1)
mod_nulo3 <- update(mod3, . ~ 1 + (1|origen))

AIC(mod2, mod3, mod4, mod_nulo2, mod_nulo3) %>% arrange(AIC)

# Resultados
summary(mod4)
sjPlot::tab_model(mod4, show.se = TRUE, show.icc=FALSE)

# Testeo de la significancia del modelo
confint(mod4, level=0.95)
anova(mod4, mod_nulo3, test="LRT")

# Extracción de los R2
#Marginal: explicado por fixed
#Condicional: explicado por ambos fixed y random
r.squaredGLMM(mod4) 

# Gráfico del modelo
ranas$predicho <- predict(mod4, ranas)

ggplot(ranas,aes(x=long_mm, y=peso_mg, color=origen)) + 
  geom_line(aes(y=predicho), size=1)+
  geom_abline(intercept=2458.18, slope=89.02, lwd=1.2, lty=2)+
  geom_point(alpha = 0.5, size=3) + 
  theme_bw()+
  see::scale_color_flat()+
  labs(x="Longitud (mm)", y="Peso (mg)", color="Zona de Origen")

sjPlot::plot_model(mod3, type="re", vline.color = "black")+
  theme_bw()+
  labs(title="", y="Variación en el efecto respecto al promedio poblacional",
       x="Origen")
```

## **1.3. Ejecución del Modelo Lineal de Efectos Mixtos con anidamiento**

```{r}
# Carga la base de datos oats de la libreria MASS
library(MASS)
data("oats")
View(oats)

# Crear modelos
# Modelo LM con interacion entre N y V, y efecto de B
lm <- lm(Y ~ N*V + B, data = oats)
summary(lm)

# Modelo LM con v
ModV <- lm(Y ~ V, data=oats)

# Modelo LM con ineraccion entre N y V
ModVN <- lm(Y ~ V*N, data=oats)

# Modelo LMM con interaccion V y N, y efecto aleatorio B
Mod1 <- lmer(Y ~ V*N + (1|B), data=oats, REML=FALSE)

# Modelo LMM con interaccion V y N, y efecto aleatorio V anidado en B 
Mod2 <- lmer(Y ~ V*N + (1|B/V), data=oats, REML=FALSE)

# Modelo LMM efecto fijo N, y efecto aleatorio V anidadoB
Mod3 <- lmer(Y ~ N + (1|B/V), data=oats, REML=FALSE)

# Selección de modelos
AIC(ModV, ModVN, Mod1, Mod2, Mod3) %>% arrange(AIC)

# Significancia del mejor modelo
Mod3_nulo <- update(Mod3, . ~  1 +  (1|B/V))
anova(Mod3, Mod3_nulo, test="LRT")

# Modelo final
final <- lmer(Y ~ N + (1|B/V), data=oats, REML=TRUE)
summary(final)
sjPlot::tab_model(final, auto.label=FALSE, show.icc=FALSE)

# Gráficos del modelo
oats$predicho <- predict(final, oats)

ggplot(oats,aes(x=N, y=Y, color=B)) + 
  geom_line(aes(y=predicho), size=1)+
  geom_jitter(alpha = 0.5, size=3) + 
  theme_bw()+
  see::scale_color_flat()+
  labs(x="Longitud (mm)", y="Peso (mg)", color="Zona de Origen")

sjPlot::plot_model(final, type="re", vline.color = "black")[[1]]+
  theme_bw()

sjPlot::plot_model(final, type="re", vline.color = "black")[[2]]+
  theme_bw()

```


